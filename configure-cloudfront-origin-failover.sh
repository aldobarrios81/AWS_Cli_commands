#!/bin/bash
# configure-cloudfront-origin-failover.sh
# Configuraci√≥n de CloudFront Origin Failover para alta disponibilidad
# Implementa redundancia y failover autom√°tico entre or√≠genes primarios y secundarios

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Verificar argumentos
if [ $# -lt 1 ]; then
    echo "Uso: $0 <PERFIL_AWS> [REGION]"
    echo "Ejemplo: $0 ancla us-east-1"
    exit 1
fi

PROFILE="$1"
REGION="${2:-us-east-1}"

echo "=================================================================="
echo -e "${BLUE}üåê CONFIGURANDO CLOUDFRONT ORIGIN FAILOVER${NC}"
echo "=================================================================="
echo -e "Perfil: ${GREEN}$PROFILE${NC} | Regi√≥n: ${GREEN}$REGION${NC}"
echo -e "Implementando alta disponibilidad y redundancia en CloudFront"
echo ""

echo -e "${PURPLE}üîç Verificando prerrequisitos...${NC}"

# Verificar AWS CLI
aws_version=$(aws --version 2>/dev/null | head -n1)
if [ $? -eq 0 ]; then
    echo -e "‚úÖ AWS CLI encontrado: ${GREEN}$aws_version${NC}"
else
    echo -e "${RED}‚ùå AWS CLI no encontrado${NC}"
    exit 1
fi

# Verificar credenciales
echo -e "${PURPLE}üîê Verificando credenciales para perfil '$PROFILE'...${NC}"
ACCOUNT_ID=$(aws sts get-caller-identity --profile "$PROFILE" --query Account --output text 2>/dev/null)

if [ $? -eq 0 ] && [ -n "$ACCOUNT_ID" ]; then
    echo -e "‚úÖ Account ID: ${GREEN}$ACCOUNT_ID${NC}"
else
    echo -e "${RED}‚ùå Error de credenciales para perfil $PROFILE${NC}"
    exit 1
fi

# Verificar permisos CloudFront
echo -e "${PURPLE}üîí Verificando permisos CloudFront...${NC}"
cloudfront_test=$(aws cloudfront list-distributions --profile "$PROFILE" --query 'DistributionList.Items[0].Id' --output text 2>/dev/null)
if [ $? -eq 0 ]; then
    echo -e "‚úÖ Permisos CloudFront confirmados"
else
    echo -e "${RED}‚ùå Sin permisos CloudFront o error de acceso${NC}"
    exit 1
fi

echo ""

# Funci√≥n para obtener distribuciones CloudFront
get_cloudfront_distributions() {
    local profile="$1"
    
    echo -e "${PURPLE}üìã Obteniendo distribuciones CloudFront...${NC}"
    
    local distributions=$(aws cloudfront list-distributions \
        --profile "$profile" \
        --query 'DistributionList.Items[].[Id,DomainName,Status,Enabled,Comment]' \
        --output text 2>/dev/null)
    
    if [ $? -ne 0 ] || [ -z "$distributions" ]; then
        echo -e "‚ùå No se encontraron distribuciones CloudFront"
        return 1
    fi
    
    echo -e "üìä Distribuciones encontradas:"
    echo "$distributions" | while IFS=$'\t' read -r id domain status enabled comment; do
        if [ -n "$id" ]; then
            local status_icon="‚ùì"
            case "$status" in
                "Deployed") status_icon="‚úÖ" ;;
                "InProgress") status_icon="üîÑ" ;;
                *) status_icon="‚ö†Ô∏è" ;;
            esac
            
            local enabled_icon="‚ùå"
            [ "$enabled" = "True" ] && enabled_icon="‚úÖ"
            
            echo -e "   üåê ${CYAN}$id${NC}"
            echo -e "      üîó Dominio: ${BLUE}$domain${NC}"
            echo -e "      $status_icon Estado: ${GREEN}$status${NC}"
            echo -e "      $enabled_icon Habilitado: $enabled"
            echo -e "      üí¨ Descripci√≥n: $comment"
            echo ""
        fi
    done
}

# Funci√≥n para analizar configuraci√≥n de origen actual
analyze_origin_configuration() {
    local profile="$1"
    local distribution_id="$2"
    
    echo -e "${PURPLE}üîç Analizando configuraci√≥n de or√≠genes para distribuci√≥n $distribution_id...${NC}"
    
    # Obtener configuraci√≥n completa
    local config_file="/tmp/cloudfront-config-$distribution_id-$(date +%s).json"
    
    aws cloudfront get-distribution-config \
        --id "$distribution_id" \
        --profile "$profile" \
        --output json > "$config_file" 2>/dev/null
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Error obteniendo configuraci√≥n de distribuci√≥n $distribution_id${NC}"
        return 1
    fi
    
    # Extraer informaci√≥n de or√≠genes
    local origins=$(jq -r '.DistributionConfig.Origins.Items[] | "\(.Id)|\(.DomainName)|\(.CustomOriginConfig.OriginProtocolPolicy // .S3OriginConfig.OriginAccessIdentity // "N/A")"' "$config_file" 2>/dev/null)
    
    # Extraer informaci√≥n de grupos de or√≠genes
    local origin_groups=$(jq -r '.DistributionConfig.OriginGroups.Items[]? | "\(.Id)|\(.Members.Items[0].OriginId)|\(.Members.Items[1].OriginId // "NONE")|\(.FailoverCriteria.StatusCodes.Items | join(","))"' "$config_file" 2>/dev/null)
    
    echo -e "üìä An√°lisis de configuraci√≥n:"
    echo ""
    
    echo -e "üéØ ${CYAN}OR√çGENES CONFIGURADOS:${NC}"
    if [ -n "$origins" ]; then
        echo "$origins" | while IFS='|' read -r origin_id domain_name config_info; do
            echo -e "   üåê ID: ${BLUE}$origin_id${NC}"
            echo -e "      üîó Dominio: ${GREEN}$domain_name${NC}"
            echo -e "      ‚öôÔ∏è Configuraci√≥n: $config_info"
            echo ""
        done
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è No se pudieron obtener detalles de or√≠genes${NC}"
    fi
    
    echo -e "üîÑ ${CYAN}GRUPOS DE FAILOVER:${NC}"
    if [ -n "$origin_groups" ] && [ "$origin_groups" != "" ]; then
        echo "$origin_groups" | while IFS='|' read -r group_id primary_origin secondary_origin status_codes; do
            echo -e "   üè∑Ô∏è Grupo ID: ${BLUE}$group_id${NC}"
            echo -e "      1Ô∏è‚É£ Origen Primario: ${GREEN}$primary_origin${NC}"
            echo -e "      2Ô∏è‚É£ Origen Secundario: ${YELLOW}$secondary_origin${NC}"
            echo -e "      üìä C√≥digos Failover: ${CYAN}$status_codes${NC}"
            echo ""
        done
    else
        echo -e "   ${RED}‚ùå No hay grupos de origen configurados (Failover NO habilitado)${NC}"
        echo -e "   ${YELLOW}üí° Se recomienda configurar Origin Failover para alta disponibilidad${NC}"
    fi
    
    # Analizar comportamientos de cache
    echo -e "üìã ${CYAN}COMPORTAMIENTOS DE CACHE:${NC}"
    local behaviors=$(jq -r '.DistributionConfig.DefaultCacheBehavior.TargetOriginId as $default | 
                             [{"PathPattern": "Default", "OriginId": $default}] + 
                             [.DistributionConfig.CacheBehaviors.Items[]? | {"PathPattern": .PathPattern, "OriginId": .TargetOriginId}] | 
                             .[] | "\(.PathPattern)|\(.OriginId)"' "$config_file" 2>/dev/null)
    
    if [ -n "$behaviors" ]; then
        echo "$behaviors" | while IFS='|' read -r path_pattern origin_id; do
            echo -e "   üìÅ Patr√≥n: ${BLUE}$path_pattern${NC} ‚Üí Origen: ${GREEN}$origin_id${NC}"
        done
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è No se pudieron obtener comportamientos de cache${NC}"
    fi
    
    # Guardar archivo de configuraci√≥n para referencia
    echo ""
    echo -e "üíæ Configuraci√≥n guardada en: ${GREEN}$config_file${NC}"
    
    # Extraer ETag para futuras actualizaciones
    local etag=$(jq -r '.ETag' "$config_file" 2>/dev/null)
    echo -e "üè∑Ô∏è ETag actual: ${CYAN}$etag${NC}"
    
    # Guardar informaci√≥n para uso posterior
    echo "$distribution_id|$config_file|$etag" > "/tmp/cf-distribution-info-$distribution_id.txt"
    
    return 0
}

# Funci√≥n para crear configuraci√≥n de Origin Group con Failover
create_origin_group_config() {
    local primary_origin="$1"
    local secondary_origin="$2"
    local group_id="$3"
    local status_codes="${4:-403,404,500,502,503,504}"
    
    echo -e "${PURPLE}üîß Creando configuraci√≥n de Origin Group...${NC}"
    
    # Generar configuraci√≥n JSON para Origin Group
    local origin_group_config=$(cat << EOF
{
    "Id": "$group_id",
    "FailoverCriteria": {
        "StatusCodes": {
            "Quantity": $(echo "$status_codes" | tr ',' '\n' | wc -l),
            "Items": [$(echo "$status_codes" | sed 's/,/, /g')]
        }
    },
    "Members": {
        "Quantity": 2,
        "Items": [
            {
                "OriginId": "$primary_origin"
            },
            {
                "OriginId": "$secondary_origin"
            }
        ]
    }
}
EOF
)
    
    echo -e "‚úÖ Configuraci√≥n de Origin Group creada:"
    echo -e "   üè∑Ô∏è ID del Grupo: ${BLUE}$group_id${NC}"
    echo -e "   1Ô∏è‚É£ Origen Primario: ${GREEN}$primary_origin${NC}"
    echo -e "   2Ô∏è‚É£ Origen Secundario: ${YELLOW}$secondary_origin${NC}"
    echo -e "   üìä C√≥digos de Failover: ${CYAN}$status_codes${NC}"
    
    echo "$origin_group_config"
}

# Funci√≥n para configurar failover autom√°tico
configure_origin_failover() {
    local profile="$1"
    local distribution_id="$2"
    local primary_origin="$3"
    local secondary_origin="$4"
    local group_id="${5:-failover-group-$(date +%s)}"
    
    echo -e "${PURPLE}üîÑ Configurando Origin Failover para distribuci√≥n $distribution_id...${NC}"
    
    # Verificar que la informaci√≥n de distribuci√≥n existe
    local info_file="/tmp/cf-distribution-info-$distribution_id.txt"
    if [ ! -f "$info_file" ]; then
        echo -e "${RED}‚ùå Informaci√≥n de distribuci√≥n no encontrada. Ejecute primero el an√°lisis.${NC}"
        return 1
    fi
    
    local config_info=$(cat "$info_file")
    IFS='|' read -r dist_id config_file etag <<< "$config_info"
    
    if [ ! -f "$config_file" ]; then
        echo -e "${RED}‚ùå Archivo de configuraci√≥n no encontrado: $config_file${NC}"
        return 1
    fi
    
    echo -e "üìã Par√°metros de configuraci√≥n:"
    echo -e "   üÜî Distribuci√≥n: ${BLUE}$distribution_id${NC}"
    echo -e "   1Ô∏è‚É£ Origen Primario: ${GREEN}$primary_origin${NC}"
    echo -e "   2Ô∏è‚É£ Origen Secundario: ${YELLOW}$secondary_origin${NC}"
    echo -e "   üè∑Ô∏è ID del Grupo: ${CYAN}$group_id${NC}"
    echo ""
    
    # Verificar que los or√≠genes existen en la distribuci√≥n
    echo -e "${PURPLE}üîç Verificando or√≠genes existentes...${NC}"
    
    local primary_exists=$(jq -r --arg origin_id "$primary_origin" '.DistributionConfig.Origins.Items[] | select(.Id == $origin_id) | .Id' "$config_file" 2>/dev/null)
    local secondary_exists=$(jq -r --arg origin_id "$secondary_origin" '.DistributionConfig.Origins.Items[] | select(.Id == $origin_id) | .Id' "$config_file" 2>/dev/null)
    
    if [ "$primary_exists" != "$primary_origin" ]; then
        echo -e "${RED}‚ùå Origen primario '$primary_origin' no existe en la distribuci√≥n${NC}"
        return 1
    fi
    
    if [ "$secondary_exists" != "$secondary_origin" ]; then
        echo -e "${RED}‚ùå Origen secundario '$secondary_origin' no existe en la distribuci√≥n${NC}"
        return 1
    fi
    
    echo -e "‚úÖ Ambos or√≠genes verificados exitosamente"
    echo ""
    
    # Crear nueva configuraci√≥n con Origin Group
    local updated_config_file="/tmp/cloudfront-updated-config-$distribution_id-$(date +%s).json"
    
    # Generar configuraci√≥n de Origin Group
    local origin_group_json=$(create_origin_group_config "$primary_origin" "$secondary_origin" "$group_id")
    
    # Actualizar configuraci√≥n a√±adiendo el Origin Group
    echo -e "${PURPLE}üîß Actualizando configuraci√≥n de distribuci√≥n...${NC}"
    
    jq --argjson origin_group "$origin_group_json" '
        .DistributionConfig.OriginGroups.Quantity = (.DistributionConfig.OriginGroups.Quantity // 0) + 1 |
        .DistributionConfig.OriginGroups.Items = (.DistributionConfig.OriginGroups.Items // []) + [$origin_group] |
        del(.ETag)
    ' "$config_file" > "$updated_config_file"
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Error actualizando configuraci√≥n${NC}"
        return 1
    fi
    
    echo -e "‚úÖ Configuraci√≥n actualizada generada"
    echo ""
    
    # Mostrar resumen de cambios
    echo -e "${CYAN}üìä RESUMEN DE CAMBIOS:${NC}"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo -e "üîÑ Se a√±adir√° Origin Group con ID: ${BLUE}$group_id${NC}"
    echo -e "1Ô∏è‚É£ Origen Primario: ${GREEN}$primary_origin${NC} (traffic normal)"
    echo -e "2Ô∏è‚É£ Origen Secundario: ${YELLOW}$secondary_origin${NC} (failover autom√°tico)"
    echo -e "üìä C√≥digos de failover: ${CYAN}403, 404, 500, 502, 503, 504${NC}"
    echo -e "‚ö° Failover: Autom√°tico cuando el origen primario falle"
    echo ""
    
    # Preguntar confirmaci√≥n
    echo -e "${YELLOW}‚ö†Ô∏è Esta operaci√≥n modificar√° la distribuci√≥n CloudFront${NC}"
    echo -e "${YELLOW}üí° Los cambios pueden tomar 15-30 minutos en propagarse globalmente${NC}"
    echo ""
    read -p "¬øDesea continuar con la configuraci√≥n? (y/N): " confirmation
    
    if [[ ! "$confirmation" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚ùå Configuraci√≥n cancelada por el usuario${NC}"
        return 1
    fi
    
    # Aplicar configuraci√≥n
    echo -e "${PURPLE}üöÄ Aplicando configuraci√≥n de Origin Failover...${NC}"
    
    local update_result=$(aws cloudfront update-distribution \
        --id "$distribution_id" \
        --distribution-config file://"$updated_config_file" \
        --if-match "$etag" \
        --profile "$profile" \
        --output json 2>/dev/null)
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Origin Failover configurado exitosamente${NC}"
        
        # Extraer informaci√≥n de la respuesta
        local new_etag=$(echo "$update_result" | jq -r '.ETag' 2>/dev/null)
        local status=$(echo "$update_result" | jq -r '.Distribution.Status' 2>/dev/null)
        local domain=$(echo "$update_result" | jq -r '.Distribution.DomainName' 2>/dev/null)
        
        echo -e "üè∑Ô∏è Nuevo ETag: ${CYAN}$new_etag${NC}"
        echo -e "üìä Estado: ${GREEN}$status${NC}"
        echo -e "üåê Dominio: ${BLUE}$domain${NC}"
        echo ""
        
        # Guardar configuraci√≥n de respaldo
        local backup_file="cloudfront-backup-$distribution_id-$(date +%Y%m%d-%H%M%S).json"
        cp "$config_file" "$backup_file"
        echo -e "üíæ Respaldo de configuraci√≥n original: ${GREEN}$backup_file${NC}"
        echo ""
        
        echo -e "${GREEN}üéâ CONFIGURACI√ìN COMPLETADA${NC}"
        echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo -e "‚úÖ Origin Failover habilitado para distribuci√≥n ${BLUE}$distribution_id${NC}"
        echo -e "üîÑ Tiempo de propagaci√≥n: ${YELLOW}15-30 minutos${NC}"
        echo -e "üìà Alta disponibilidad: ${GREEN}ACTIVADA${NC}"
        echo ""
        
        return 0
    else
        echo -e "${RED}‚ùå Error aplicando configuraci√≥n de Origin Failover${NC}"
        
        # Intentar obtener m√°s informaci√≥n del error
        local error_info=$(aws cloudfront update-distribution \
            --id "$distribution_id" \
            --distribution-config file://"$updated_config_file" \
            --if-match "$etag" \
            --profile "$profile" 2>&1)
        
        echo -e "${RED}Error detallado: $error_info${NC}"
        return 1
    fi
}

# Funci√≥n para crear un origen secundario
create_secondary_origin() {
    local profile="$1"
    local distribution_id="$2"
    local origin_id="$3"
    local domain_name="$4"
    local origin_path="${5:-}"
    
    echo -e "${PURPLE}üÜï Creando origen secundario...${NC}"
    
    # Obtener configuraci√≥n actual
    local info_file="/tmp/cf-distribution-info-$distribution_id.txt"
    if [ ! -f "$info_file" ]; then
        echo -e "${RED}‚ùå Informaci√≥n de distribuci√≥n no encontrada${NC}"
        return 1
    fi
    
    local config_info=$(cat "$info_file")
    IFS='|' read -r dist_id config_file etag <<< "$config_info"
    
    # Crear configuraci√≥n del nuevo origen
    local new_origin_config=$(cat << EOF
{
    "Id": "$origin_id",
    "DomainName": "$domain_name",
    "OriginPath": "$origin_path",
    "CustomOriginConfig": {
        "HTTPPort": 80,
        "HTTPSPort": 443,
        "OriginProtocolPolicy": "https-only",
        "OriginSslProtocols": {
            "Quantity": 2,
            "Items": ["TLSv1.2", "TLSv1.3"]
        }
    }
}
EOF
)
    
    # Actualizar configuraci√≥n a√±adiendo el nuevo origen
    local updated_config_file="/tmp/cloudfront-updated-config-origin-$distribution_id-$(date +%s).json"
    
    jq --argjson new_origin "$new_origin_config" '
        .DistributionConfig.Origins.Quantity = .DistributionConfig.Origins.Quantity + 1 |
        .DistributionConfig.Origins.Items = .DistributionConfig.Origins.Items + [$new_origin] |
        del(.ETag)
    ' "$config_file" > "$updated_config_file"
    
    echo -e "‚úÖ Configuraci√≥n de origen secundario creada:"
    echo -e "   üÜî ID: ${BLUE}$origin_id${NC}"
    echo -e "   üåê Dominio: ${GREEN}$domain_name${NC}"
    echo -e "   üìÅ Ruta: ${CYAN}$origin_path${NC}"
    
    echo "$updated_config_file|$etag"
}

# Funci√≥n para verificar estado de failover
verify_failover_status() {
    local profile="$1"
    local distribution_id="$2"
    
    echo -e "${PURPLE}üîç Verificando estado de Origin Failover...${NC}"
    
    # Obtener configuraci√≥n actual
    local current_config=$(aws cloudfront get-distribution-config \
        --id "$distribution_id" \
        --profile "$profile" \
        --output json 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Error obteniendo configuraci√≥n actual${NC}"
        return 1
    fi
    
    # Verificar Origin Groups
    local origin_groups=$(echo "$current_config" | jq -r '.DistributionConfig.OriginGroups.Items[]? | "\(.Id)|\(.Members.Items[0].OriginId)|\(.Members.Items[1].OriginId)|\(.FailoverCriteria.StatusCodes.Items | join(","))"' 2>/dev/null)
    
    local status=$(echo "$current_config" | jq -r '.Distribution.Status' 2>/dev/null)
    local last_modified=$(echo "$current_config" | jq -r '.Distribution.LastModifiedTime' 2>/dev/null)
    
    echo -e "üìä Estado de la distribuci√≥n:"
    echo -e "   üÜî ID: ${BLUE}$distribution_id${NC}"
    echo -e "   üìä Estado: ${GREEN}$status${NC}"
    echo -e "   üìÖ √öltima modificaci√≥n: ${CYAN}$last_modified${NC}"
    echo ""
    
    if [ -n "$origin_groups" ] && [ "$origin_groups" != "" ]; then
        echo -e "${GREEN}‚úÖ Origin Failover CONFIGURADO${NC}"
        echo ""
        echo -e "üîÑ ${CYAN}GRUPOS DE FAILOVER ACTIVOS:${NC}"
        echo "$origin_groups" | while IFS='|' read -r group_id primary secondary codes; do
            echo -e "   üè∑Ô∏è Grupo: ${BLUE}$group_id${NC}"
            echo -e "   1Ô∏è‚É£ Primario: ${GREEN}$primary${NC}"
            echo -e "   2Ô∏è‚É£ Secundario: ${YELLOW}$secondary${NC}"
            echo -e "   üìä C√≥digos: ${CYAN}$codes${NC}"
            echo ""
        done
        
        if [ "$status" = "Deployed" ]; then
            echo -e "${GREEN}üéâ Failover ACTIVO y DESPLEGADO${NC}"
            echo -e "${BLUE}üí° La alta disponibilidad est√° completamente funcional${NC}"
        else
            echo -e "${YELLOW}‚è≥ Failover configurado, esperando despliegue...${NC}"
            echo -e "${BLUE}üí° Estado actual: $status${NC}"
        fi
    else
        echo -e "${RED}‚ùå Origin Failover NO configurado${NC}"
        echo -e "${YELLOW}üí° Esta distribuci√≥n no tiene redundancia de or√≠genes${NC}"
    fi
    
    return 0
}

# Funci√≥n para generar reporte de configuraci√≥n
generate_failover_report() {
    local profile="$1"
    local output_file="cloudfront-failover-report-$(date +%Y%m%d-%H%M%S).json"
    
    echo -e "${PURPLE}üìä Generando reporte de configuraci√≥n de failover...${NC}"
    
    # Obtener todas las distribuciones
    local distributions=$(aws cloudfront list-distributions \
        --profile "$profile" \
        --query 'DistributionList.Items[].Id' \
        --output text 2>/dev/null)
    
    if [ -z "$distributions" ]; then
        echo -e "${RED}‚ùå No se encontraron distribuciones${NC}"
        return 1
    fi
    
    # Crear estructura base del reporte
    cat > "$output_file" << EOF
{
    "report_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "account_id": "$ACCOUNT_ID",
    "profile": "$profile",
    "cloudfront_distributions": []
}
EOF
    
    # Analizar cada distribuci√≥n
    local temp_report="/tmp/cf-temp-report-$$.json"
    echo "[]" > "$temp_report"
    
    echo "$distributions" | while read -r dist_id; do
        if [ -n "$dist_id" ]; then
            echo -e "   üîç Analizando distribuci√≥n ${CYAN}$dist_id${NC}..."
            
            # Obtener configuraci√≥n de la distribuci√≥n
            local dist_config=$(aws cloudfront get-distribution-config \
                --id "$dist_id" \
                --profile "$profile" \
                --output json 2>/dev/null)
            
            if [ $? -eq 0 ]; then
                # Extraer informaci√≥n relevante
                local domain=$(echo "$dist_config" | jq -r '.Distribution.DomainName')
                local status=$(echo "$dist_config" | jq -r '.Distribution.Status')
                local enabled=$(echo "$dist_config" | jq -r '.DistributionConfig.Enabled')
                local origins_count=$(echo "$dist_config" | jq -r '.DistributionConfig.Origins.Quantity')
                local origin_groups_count=$(echo "$dist_config" | jq -r '.DistributionConfig.OriginGroups.Quantity // 0')
                
                # Determinar estado de failover
                local failover_status="disabled"
                if [ "$origin_groups_count" -gt 0 ]; then
                    failover_status="enabled"
                fi
                
                # Crear entrada del reporte
                local dist_report=$(cat << EOF
{
    "distribution_id": "$dist_id",
    "domain_name": "$domain",
    "status": "$status",
    "enabled": $enabled,
    "origins_count": $origins_count,
    "origin_groups_count": $origin_groups_count,
    "failover_status": "$failover_status",
    "high_availability": $([ "$origin_groups_count" -gt 0 ] && echo "true" || echo "false")
}
EOF
)
                
                # A√±adir al reporte temporal
                jq --argjson dist "$dist_report" '. += [$dist]' "$temp_report" > "${temp_report}.new"
                mv "${temp_report}.new" "$temp_report"
            fi
        fi
    done
    
    # Combinar reporte final
    jq --slurpfile distributions "$temp_report" '.cloudfront_distributions = $distributions[0]' "$output_file" > "${output_file}.final"
    mv "${output_file}.final" "$output_file"
    
    # Limpiar archivos temporales
    rm -f "$temp_report"
    
    echo -e "‚úÖ Reporte generado: ${GREEN}$output_file${NC}"
    
    # Mostrar resumen
    local total_distributions=$(jq -r '.cloudfront_distributions | length' "$output_file")
    local with_failover=$(jq -r '.cloudfront_distributions | map(select(.failover_status == "enabled")) | length' "$output_file")
    local without_failover=$(jq -r '.cloudfront_distributions | map(select(.failover_status == "disabled")) | length' "$output_file")
    
    echo ""
    echo -e "${CYAN}üìä RESUMEN DEL REPORTE:${NC}"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo -e "üìã Total distribuciones: ${BLUE}$total_distributions${NC}"
    echo -e "‚úÖ Con failover habilitado: ${GREEN}$with_failover${NC}"
    echo -e "‚ùå Sin failover: ${RED}$without_failover${NC}"
    
    local coverage_percent=0
    if [ "$total_distributions" -gt 0 ]; then
        coverage_percent=$((with_failover * 100 / total_distributions))
    fi
    echo -e "üìà Cobertura de alta disponibilidad: ${CYAN}$coverage_percent%${NC}"
    
    if [ "$without_failover" -gt 0 ]; then
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è RECOMENDACIONES:${NC}"
        echo -e "‚Ä¢ Configurar Origin Failover para las $without_failover distribuciones restantes"
        echo -e "‚Ä¢ Implementar monitoreo de salud de or√≠genes"
        echo -e "‚Ä¢ Configurar alertas para failover autom√°tico"
        echo -e "‚Ä¢ Revisar regularmente la configuraci√≥n de redundancia"
    else
        echo ""
        echo -e "${GREEN}üéâ ¬°Excelente! Todas las distribuciones tienen failover configurado${NC}"
    fi
    
    return 0
}

# Funci√≥n para mostrar men√∫ interactivo
show_interactive_menu() {
    local profile="$1"
    
    while true; do
        echo ""
        echo -e "${CYAN}üåê MEN√ö CLOUDFRONT ORIGIN FAILOVER${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅÔøΩÔøΩÔøΩ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo -e "${BLUE}1.${NC} üìã Listar distribuciones CloudFront"
        echo -e "${BLUE}2.${NC} üîç Analizar configuraci√≥n de distribuci√≥n espec√≠fica"
        echo -e "${BLUE}3.${NC} üîÑ Configurar Origin Failover"
        echo -e "${BLUE}4.${NC} üÜï Crear origen secundario"
        echo -e "${BLUE}5.${NC} ‚úÖ Verificar estado de failover"
        echo -e "${BLUE}6.${NC} üìä Generar reporte de configuraciones"
        echo -e "${BLUE}7.${NC} ‚ùå Salir"
        echo ""
        
        read -p "Seleccione una opci√≥n (1-7): " choice
        
        case $choice in
            1)
                echo ""
                get_cloudfront_distributions "$profile"
                ;;
            2)
                echo ""
                read -p "Ingrese el ID de la distribuci√≥n: " dist_id
                if [ -n "$dist_id" ]; then
                    analyze_origin_configuration "$profile" "$dist_id"
                else
                    echo -e "${RED}‚ùå ID de distribuci√≥n requerido${NC}"
                fi
                ;;
            3)
                echo ""
                read -p "ID de la distribuci√≥n: " dist_id
                read -p "ID del origen primario: " primary_origin
                read -p "ID del origen secundario: " secondary_origin
                read -p "ID del grupo de failover (opcional): " group_id
                
                if [ -n "$dist_id" ] && [ -n "$primary_origin" ] && [ -n "$secondary_origin" ]; then
                    # Primero analizar para obtener configuraci√≥n actual
                    analyze_origin_configuration "$profile" "$dist_id"
                    # Luego configurar failover
                    configure_origin_failover "$profile" "$dist_id" "$primary_origin" "$secondary_origin" "$group_id"
                else
                    echo -e "${RED}‚ùå Todos los campos son requeridos${NC}"
                fi
                ;;
            4)
                echo ""
                read -p "ID de la distribuci√≥n: " dist_id
                read -p "ID del nuevo origen: " origin_id
                read -p "Dominio del origen: " domain_name
                read -p "Ruta del origen (opcional): " origin_path
                
                if [ -n "$dist_id" ] && [ -n "$origin_id" ] && [ -n "$domain_name" ]; then
                    # Analizar primero para obtener configuraci√≥n
                    analyze_origin_configuration "$profile" "$dist_id"
                    create_secondary_origin "$profile" "$dist_id" "$origin_id" "$domain_name" "$origin_path"
                else
                    echo -e "${RED}‚ùå ID de distribuci√≥n, ID de origen y dominio son requeridos${NC}"
                fi
                ;;
            5)
                echo ""
                read -p "ID de la distribuci√≥n: " dist_id
                if [ -n "$dist_id" ]; then
                    verify_failover_status "$profile" "$dist_id"
                else
                    echo -e "${RED}‚ùå ID de distribuci√≥n requerido${NC}"
                fi
                ;;
            6)
                echo ""
                generate_failover_report "$profile"
                ;;
            7)
                echo -e "${GREEN}üëã ¬°Hasta luego!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå Opci√≥n inv√°lida. Seleccione 1-7.${NC}"
                ;;
        esac
        
        echo ""
        read -p "Presione Enter para continuar..."
    done
}

# Funci√≥n principal de ejecuci√≥n
main() {
    # Verificar si hay argumentos adicionales para ejecuci√≥n no interactiva
    if [ $# -gt 2 ]; then
        local action="$3"
        case "$action" in
            "list")
                get_cloudfront_distributions "$PROFILE"
                ;;
            "analyze")
                if [ $# -ge 4 ]; then
                    analyze_origin_configuration "$PROFILE" "$4"
                else
                    echo -e "${RED}‚ùå ID de distribuci√≥n requerido para an√°lisis${NC}"
                    exit 1
                fi
                ;;
            "configure")
                if [ $# -ge 6 ]; then
                    local dist_id="$4"
                    local primary="$5"
                    local secondary="$6"
                    local group_id="${7:-failover-group-$(date +%s)}"
                    
                    analyze_origin_configuration "$PROFILE" "$dist_id"
                    configure_origin_failover "$PROFILE" "$dist_id" "$primary" "$secondary" "$group_id"
                else
                    echo -e "${RED}‚ùå Par√°metros insuficientes para configuraci√≥n${NC}"
                    echo "Uso: $0 $PROFILE $REGION configure <dist_id> <primary_origin> <secondary_origin> [group_id]"
                    exit 1
                fi
                ;;
            "verify")
                if [ $# -ge 4 ]; then
                    verify_failover_status "$PROFILE" "$4"
                else
                    echo -e "${RED}‚ùå ID de distribuci√≥n requerido para verificaci√≥n${NC}"
                    exit 1
                fi
                ;;
            "report")
                generate_failover_report "$PROFILE"
                ;;
            *)
                echo -e "${RED}‚ùå Acci√≥n no reconocida: $action${NC}"
                echo "Acciones disponibles: list, analyze, configure, verify, report"
                exit 1
                ;;
        esac
    else
        # Modo interactivo
        show_interactive_menu "$PROFILE"
    fi
}

# Ejecutar funci√≥n principal
main "$@"